---
title: "snRNAseq_cluster_labeling"
author: "Katie Prater and Kevin Green"
date: "6/26/2020"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(stringr)
library(dplyr)
library(filesstrings)
library(tidyverse)
```
#Jayadev Lab snRNAseq Pipeline

##Removal of unwanted effects for cleanup of data

### R Markdown note:
This is an R Markdown document. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

##First ensure you have the variables and directories set up as needed for the project. This should be identical to the code chunk you edited the first time. ***You DO need to edit this code chunk! ***
```{r Setup}
#Define your project folder:
#projdir <- "path_to_my_project_folder_name"
projdir <- "../"

#Previous data file name: (give the name for the appopriate RDS/Rdata file)
prev_data <- "QCd_norm_anchored_clustered_ws_pu1_only.rdata"

#Resolution chosen from previous clustering to use to label clusters:
chose_resolution <- "0.4"

#Cluster identities (in order 0-N):
cluster_idents <- c("Microglia 1",
                    "Microglia 2",
                    "Microglia 3",
                    "Microglia 4",
                    "Astrocytes 1",
                    "Microglia 5",
                    "Unspecified 1",
                    "Glut Neurons 1",
                    "Glut Neurons 2",
                    "Microglia 6",
                    "Oligodendrocytes 1",
                    "Gabaergic Neurons 1",
                    "Unspecified 2",
                    "Glut Neurons 3",
                    "Doublets?",
                    "Endothelial Cells",
                    "OPC",
                    "Oligodendrocytes 2",
                    "Astrocytes?")

#__________________**DO NOT EDIT BELOW THIS LINE**___________________________
```

## Load in the data you specified:
```{r Load_Data}
#Document your code:
print("This is when this code was started:")
print(Sys.time())

#Make the path for the previous data file and load it into the R environment
prev_data_path<-file.path(projdir, "code", prev_data, fsep = "/")
print(paste("Loading:", prev_data_path, sep = " "))
#ss_data_norm <- readRDS(prev_data_path)
load(prev_data_path)
```

```{r Set_Directories}
#Ensure paths are set for code:
umaps_path <- file.path(outpath, "umaps", fsep = "/")
outpath <- file.path(projdir, outdir, "umaps", fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}

#Number of participants/samples to process:
numsubs <- length(samples)
print(paste("Processing", numsubs, "samples", sep = " "))

#Documentation:
print("This is where the project is:")
print(projdir)
print("This is where the sample files are:")
print(sample_dir)
print("This is where the data files will be saved:")
print(outpath)

```
## Set the cluster labels
```{r Set_Labels}
#make resolution name:
res_name<- paste0(assay, "_snn_res.", chose_resolution)

#Set cluster identities in Seurat object
Idents(object = ss_data_norm)<-res_name

#Rename clusters:
names(x = cluster_idents) <- levels(x = ss_data_norm)
ss_data_norm <- RenameIdents(object = ss_data_norm, cluster_idents)

#Make new umap
plot1 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     pt.size = 2,
                     label = TRUE,
                     label.size = 8,
                     repel = TRUE) + NoLegend()
ggsave(filename = paste0(umaps_path,"/", proj, "_", chose_resolution, "_",
                "cell_identities_onmap", suffix, ".png"), height = 7, width = 11, plot = plot1)


plot2 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     pt.size = 2)
ggsave(filename = paste0(umaps_path,"/", proj, "_", chose_resolution, "_",
                "cell_identities_legend", suffix, ".png"), height = 7, width = 11, plot = plot2)

```

```{r data_metrics}
#Ensure paths are set for code:
metrics_path <- file.path(projdir, outdir,
                          "data_metrics/", 
                          fsep = "/")
if (file.exists(metrics_path)){
  cat("data_metrics directory path works!")
} else {
  cat("data_metrics directory does not exist - creating", "\n")
  dir.create(metrics_path)
  cat("data_metrics directory created:", file.exists(metrics_path))
}

#Determines the number of cells per cluster and
#writes info into a csv file
n_cells <- FetchData(ss_data_norm, 
                     vars = "ident") %>% 
  dplyr::count(ident) %>% 
  spread(ident, n)
view(n_cells)
write.csv(n_cells, paste0(metrics_path,
                         "nCells_per_cluster",
                         suffix, ".csv"))

#Determines the average and quantiles of expression
#per single cell and writes info into a csv file

sink(paste0(metrics_path,
     "avg_genes_per_cell",
     suffix, ".csv"))
print(summary(colSums(ss_data_norm)))
sink()

#Removes objects that are no longer needed.
rm(n_cells)

```

## Save the data files.
```{r Save_Files}
rm(plot1, plot2)
#Save workspace image if needed to revisit
save.image(file = paste0("QCd_data_subset_Dx_idents_ws", suffix, ".rdata"), compress = TRUE)

```
