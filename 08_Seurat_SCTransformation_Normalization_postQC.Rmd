---
title: "Seurat_SCTransformation_Normalization"
author: "Kevin Green and Katie Prater"
date: "7/22/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, cache=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(foreach)
library(doParallel)
library(stringr)
```

# Jayadev Lab RNAseq Data Processing Pipeline

## Define your project folders, filenames, and variables of interest.
# You MUST edit this for your dataset to run properly!!!!
```{r 'Project_Information', echo=TRUE}
#Document your code:
print("This is when this code was run:")
print(Sys.time())

# Load data with ambient RNA and doublets removed
load("decon_scrubbed_thresholded_ws_pu1_only.rdata")

# Set the name of the assay to be used after normalization
# ("RNA" or "SCT")
assay <- "SCT"

#Set the number of variable genes
nfeatures <- 5000

#Create a list of variables from which to remove unwanted variation.
#e.g. c("percent.mito", "Library.Batch", "PMI")
unwanted <- c("percent.mito", "Library.Batch", "Age")#, "PMI")

#Define your project folder:
#projdir <- "path_to_my_project_folder_name"
projdir <- "/home/rstudio/hyak/single_cell/experiment_data/brain/pu1/e_b_022520_pu1"

#File path to your participant/sample files:
#sample_dir <- "path_to_my_sample_files"
sample_dir <- "/home/rstudio/hyak/single_cell/experiment_data/brain/pu1/e_b_022520_pu1"

outpath <- file.path(projdir, outdir, fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!\n")} else 
    {cat("Output directory does not exist - creating\n")
    dir.create(outpath)}

#Make a QC plots folder to save the files.
plotspath <- file.path(projdir, outdir, "qc_plots", fsep = "/")
if (file.exists(plotspath)){
  paste("The directory ", plotspath, " already exists!")
} else {
  dir.create(plotspath)
  paste("Creating directory: ", plotspath)
}

#__________________________**DO NOT EDIT BELOW THIS LINE**________________________

```

```{r data_metrics}
#Ensure paths are set for code:
metrics_path <- file.path(projdir, outdir, "data_metrics/", fsep = "/")
if (file.exists(metrics_path)){
  cat("data_metrics directory path works!")
} else {
  cat("data_metrics directory does not exist - creating", "\n")
  dir.create(metrics_path)
  cat("data_metrics directory created:", file.exists(metrics_path))
}

#Determine total number of genes and total number of cells and writes info into a csv file
totals <- dim(ss_data_scrubbed)
names(totals) <- c("genes", "cells")
print(totals)
num_cells <- table(ss_data$orig.ident) #gets number of nuclei per sample
# table <- rbind(num_cells, totals) doesn't work attempt to combine tables
write.csv(totals, paste0(metrics_path, "total_genes&cells", suffix, ".csv"))
rm(totals)

```
## Normalize using Seurat SCTransform
```{r SCTransform, warning=FALSE}

# Normalize read depth using SCTransformation
ss_data_scrubbed <- Seurat::SCTransform(ss_data_scrubbed,
                                        new.assay.name = assay,
                                        variable.features.n = nfeatures,
                                        do.scale = FALSE,
                                        do.center = FALSE,
                                        conserve.memory = TRUE,
                                        return.only.var.genes = TRUE,
                                        vars.to.regress = unwanted,
                                        verbose = FALSE)
ss_data_norm <- ss_data_scrubbed
rm(ss_data_scrubbed)

```

```{r Save_files}
#Save RData file with data and variables
save.image(file = paste0("QCd_normalized", suffix, "_ws.rdata"), compress = TRUE)
```
