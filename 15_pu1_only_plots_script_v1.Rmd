---
title: "plots_script_v1"
author: "Katie Prater"
date: "10/16/2020"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(stringr)
library(dplyr)
library(filesstrings)
```
#Jayadev Lab snRNAseq Pipeline

##Plots for the PU.1 dataset.

### R Markdown note:
This is an R Markdown document. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

##First ensure you have the variables and directories set up as needed for the project. This should be identical to the code chunk you edited the first time. ***You DO need to edit this code chunk! ***
```{r Setup}
#Previous data file name: (give the name for the appopriate RDS/Rdata file)
start_data <- "QCd_norm_anchored_clustered_wscale_ws_MG_subset_0.2subset012356_MG_subset_20200910.rdata"

#__________________**DO NOT EDIT BELOW THIS LINE**___________________________
```

## Load in the data you specified:
```{r Load_Data}
#Document your code:
print(paste("This is when this code was started:", Sys.time()))

#Load the thresholded Seurat object saved before
print(paste('Loading data', start_data, sep = " "))
load(paste0("../data/r_files/", start_data))

```

```{r Set_Directories}
#Ensure paths are set for code:
if (exists("dataset_name")){
outpath <- file.path(projdir, outdir, "umaps", dataset_name, fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}
} else {
  outpath <- file.path(projdir, outdir, "umaps", fsep = "/")
  if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}
}

#Number of participants/samples to process:
numsubs <- length(samples)
print(paste("Processing", numsubs, "samples", sep = " "))

#Documentation:
print("This is where the project is:")
print(projdir)
print("This is where the sample files are:")
print(sample_dir)
print("This is where the data files will be saved:")
print(outpath)

```

## Plots.
```{r Density_Plot}
##First ensure that the idents are set to the resolution of clusters that you want.
#Resolution chosen from previous clustering to use to label clusters:
change_resolution <- "0.3"

#Ensure resolution to be used is set properly.
if (!is.null(change_resolution)) {
chose_resolution <- change_resolution
}

#remake resolution name to ensure it's accurate:
res_name<- paste0(assay, "_snn_res.", chose_resolution)

#Set cluster identities in Seurat object to the numbers from the resolution you chose previously
Idents(object = ss_data_norm)<-res_name



#Make a UMAP plot of the clusters split by DX.
plot1 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     group.by = res_name,
                     split.by = "Dx",
                     pt.size = 0.1,
                     label = FALSE,
                     label.size = 10)
    plot1[[1]]$layers[[1]]$aes_params$alpha = .5
ggsave(filename = paste0(outpath,"/", cell_type, "_density_umap_", suffix, ".png"), height = 7, width = 11, plot = plot3)

#Heatmap of top genes
top_degs <- read_csv("hyak/projects/single_cell/brain/pu1_only/2020-07-07_15_samples/output/output_pu1_only/degs/MG_subset_0.2subset012356/PU1_pilot_top_genes_per_cluster_compared_all_res_0.3_MG_subset_0.2subset012356_MG_subset_20200910.csv")
#Find the top 3 genes per cluster
top3_genes_cluster <- top_degs %>% group_by(cluster) %>% top_n(n = 3, wt = avg_logFC)
#make a list of them to plot
top3 <- unique(pull(top3_genes_cluster, gene))
#Make a heatmap of top genes
plot3 <- DoHeatmap(ss_data_norm, 
                        features = top3,
                        assay = assay,
                        raster = FALSE,
                        hjust = 1,
                        angle = 0)
      ggsave(filename = paste0(umaps_path,"/", cell_type, "_topDEGs_expression_cluster_heatmap_", chose_resolution, suffix, ".pdf"), height = 7, width = 11, plot = plot3)


##Alternate Density plot Code:
# Establishing groups to color plots by - don't need this for now.
#group_by <- c("Dx", "Pt_ID")
# Getting coordinates for cells to use for UMAP and associated grouping variable information
class_umap_data <- FetchData(ss_data_norm,
                             vars = c("ident", "UMAP_1", "UMAP_2")) #, group_by))
den_plot <- ggplot(data = class_umap_data, aes(x = UMAP_1, y = UMAP_2)) + geom_point(alpha = 0.25, size = 0.01) + geom_density2d(colour = "red")
ggsave(filename = paste0(outpath,"/", cell_type, "_density_umap_red_lines", suffix, ".png"), height = 7, width = 11, plot = den_plot)


den_plot <- ggplot(data = class_umap_data, aes(x = UMAP_1, y = UMAP_2)) + geom_point(alpha = 0.25, size = 0.01) +
stat_density_2d(geom = "polygon", contour = TRUE,
                  aes(fill = after_stat(level)),
                  bins = 10, alpha=0.15) + 
  scale_fill_distiller(palette = "Blues", direction = 1) + geom_density2d(colour = "black") +NoLegend()
ggsave(filename = paste0(outpath,"/", cell_type, "_density_umap_blue_fill", suffix, ".png"), height = 7, width = 11, plot = den_plot)

```

## Save the data files.
```{r Save_Files}
rm(plot1, plot2, resolutions, umap_pngs, color_list, plot3, den_plot, class_umap_data)
#Save workspace image if needed to revisit
save.image(file = paste0("../data/r_files/", "QCd_norm_anchored_clustered_wscale_ws", suffix, ".rdata"), compress = TRUE)

```

