---
title: "snRNAseq_clusters_v1"
author: "Katie Prater and Kevin Green"
date: "6/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(stringr)
library(dplyr)
library(filesstrings)
```
#Jayadev Lab snRNAseq Pipeline

##Removal of unwanted batch/sample effects for cleanup of data

### R Markdown note:
This is an R Markdown document. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

##First ensure you have the variables and directories set up as needed for the project. This should be identical to the code chunk you edited the first time. ***You DO need to edit this code chunk! ***
```{r Setup}
#Define your project folder:
#projdir <- "path_to_my_project_folder_name"
projdir <- "~/jayadev/PU.1/exp_2-25-20/Full_sequence/code/pu1_only/"

#Previous data file name: (give the name for the appopriate RDS/Rdata file)
start_data <- "QCd_normalized_pu1_only_ws.rdata"

#Define the number of genes you want after variable gene detection:
nfeatures <- 5000

#Subset samples (by batch or patient group)?
sample_sub <- TRUE

#Give samples to subset:
sub_group1 <- c(1, 2, 3, 8, 11, 13)  #Controls
sub_group2 <- c(4, 5, 6, 7, 9, 10, 12, 14, 15)  #AD

#Use reference?
use_reference <- FALSE

#Set a list of reference samples to use for integration
#Set to NULL if no reference sample is used
reference_samples <- c(1, 8, 2, 3)


#__________________**DO NOT EDIT BELOW THIS LINE**___________________________
```

## Load in the data you specified:
```{r Load_Data}
#Document your code:
print("This is when this code was started:")
print(Sys.time())

#Load the thresholded Seurat object saved before
data_loc<-file.path(projdir, "code", start_data, fsep = "/")
print(paste('Loading data', start_data, sep = " "))
load(start_data)
```

```{r Set_Directories}
#Ensure paths are set for code:
outpath <- file.path(projdir, outdir, fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}

#Number of participants/samples to process:
numsubs <- length(samples)
print(paste("Processing", numsubs, "samples", sep = " "))

#Documentation:
print("This is where the project is:")
print(projdir)
print("This is where the sample files are:")
print(sample_dir)
print("This is where the data files will be saved:")
print(outpath)

```

## We split the Seurat object into individual samples to find the variable genes in each sample, generate a weighted list of those genes for all samples, and then determine integration anchors based on a reference defined above.
```{r Var_genes_&_anchors}

#Subset the samples if needed and run integration on the subsets, else run without subsetting.
if(sample_sub){#If true, subset the samples.
  
  print(paste("Subsetting dataset with", Idents(ss_data_norm[sub_group1]), "in group 1.", sep = " "))
  ss_data_norm1 <- subset(x = ss_data_norm, idents = samples[sub_group1])
  saveRDS(ss_data_norm1, file = paste0("QCd_data_anchored", suffix, "_group1.rds"))
  rm(ss_data_norm1)
  
  print(paste("Subsetting dataset with", Idents(ss_data_norm[sub_group2]), "in group 2.", sep = " "))
  ss_data_norm2 <- subset(x = ss_data_norm, 
                           idents = samples[sub_group2])
  rm(ss_data_norm)
  
 #Split the combined Seurat object into individual samples to be integrated
  ss_data_norm2 <- SplitObject(
    ss_data_norm2,
    split.by = "orig.ident")
  print(paste("Split Seurat object now has", length(unique(names(ss_data_norm2)))
, "individual samples.", sep = " "))

  #Find the variable genes for each individual samples
  ss_data_norm2 <- lapply(X = ss_data_norm2, FUN = function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nfeatures, verbose = FALSE)
})
  
   #Find the integration features similar across all samples for the top nFeatures of genes.
  Ifeatures <- SelectIntegrationFeatures(ss_data_norm2, nfeatures = nfeatures,)
  
  if(use_reference){ #If use_reference = True, run this for subgroup_2
    
    # Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above and references. 
#*Note that this step takes many hours (7 for 15 samples)
print(paste("Finding integration anchors using", names(ss_data_norm2[reference_samples2]), "as reference samples.", sep = " "))
ss_data_norm2 <-
  FindIntegrationAnchors(ss_data_norm2,
    reference = reference_samples2,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )
  }else{ #If use_reference is not true, run this for subgroup_2
    
    # Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above using no references. 
#*Note that this step takes many hours (7 for 15 samples)
print("Finding integration anchors using no reference samples.")
ss_data_norm2 <-
  FindIntegrationAnchors(ss_data_norm2,
    reference = NULL,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )
  }
  
  #Save rds of the anchorset 
  saveRDS(ss_data_norm2, file = paste0("QCd_data_anchored", suffix, "_group2.rds"))
  
  rm(ss_data_norm2)
  
  #Read in the data for subgroup_1 saved earlier
  ss_data_norm1 <- readRDS(paste0("QCd_data_anchored", suffix, "_group1.rds"))
  
  #Split the combined Seurat object into individual samples to be integrated
  ss_data_norm1 <- SplitObject(
      ss_data_norm1,
      split.by = "orig.ident")
  print(paste("Split Seurat object now has", length(unique(names(ss_data_norm1)))
, "individual samples.", sep = " "))

  #Find the variable genes for each individual samples
  ss_data_norm1 <- lapply(X = ss_data_norm1, FUN = function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nfeatures, verbose = FALSE)
  })
  
  #Find the integration features similar across all samples for the top nFeatures of genes.
  Ifeatures <- SelectIntegrationFeatures(ss_data_norm1, nfeatures = nfeatures,)
  
  if(use_reference){ #if use_reference is true, run this for subgroup_1
    
    # Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above and references. 
#*Note that this step takes many hours (7 for 15 samples)
print(paste("Finding integration anchors using", names(ss_data_norm1[reference_samples1]), "as reference samples.", sep = " "))
ss_data_norm1 <-
  FindIntegrationAnchors(ss_data_norm1,
    reference = reference_samples1,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )
  }else{ #if use_reference is false, run this for subgroup_1
    
    # Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above using no references. 
  #*Note that this step takes many hours (7 for 15 samples)
  print("Finding integration anchors using no reference samples.")
  ss_data_norm1 <-
    FindIntegrationAnchors(ss_data_norm1,
    reference = NULL,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )
  }
  
  #Save the data for subgroup_1
  saveRDS(ss_data_norm1, file = paste0("QCd_data_anchored", suffix, "_group1.rds"))
  
  #Integrate each sample together within subgroup_1.
  ss_data_norm1 <- IntegrateData(ss_data_norm1,
                              dims = 1:30)
  
  #Read in the anchorset saved for subgroup2
  ss_data_norm2 <- readRDS(paste0("QCd_data_anchored", suffix, "_group2.rds"))
  
    #Integrate each sample together within subgroup_2.
  ss_data_norm2 <- IntegrateData(ss_data_norm2,
                              dims = 1:30)

}else{ #If the data is not to be subsetted, run this:

  #Split the combined Seurat object into individual samples to be integrated
ss_data_norm <- SplitObject(
    ss_data_norm,
    split.by = "orig.ident")
print(paste("Split Seurat object now has", length(unique(names(ss_data_norm)))
, "individual samples.", sep = " "))

#Find the variable genes for each individual samples
ss_data_norm <- lapply(X = ss_data_norm, FUN = function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nfeatures, verbose = FALSE)
})
  
#Find the integration features similar across all samples for the top nFeatures of genes.
Ifeatures <- SelectIntegrationFeatures(ss_data_norm, nfeatures = nfeatures,)


# Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above. 
#*Note that this step takes many hours (7 for 15 samples)
print(paste("Finding integration anchors using", names(ss_data_norm[reference_samples]), "as reference samples.", sep = " "))
ss_data_norm <-
  FindIntegrationAnchors(ss_data_norm,
    reference = reference_samples,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )

#Save rds of the anchorset 
saveRDS(ss_data_norm, file = paste0("anchorset_data",suffix, ".rds"))

#Integrate the datasets from each sample together.
ss_data_norm <- IntegrateData(ss_data_norm,
                              dims = 1:30)
}


```
## Make a couple of quick umap plots to confirm that the batch correction worked well.
```{r UMAP_plots}

#Make a standard UMAP plot of the clusters
plot1 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     #group.by = resolutions[[resolution]],
                     pt.size = 2,
                     label = FALSE,
                     label.size = 10)
    png(paste0(plotspath, "/", proj, "_",
                "integrated_clusters", "_",
                "postQC", suffix, ".png", sep = ""), 800, 800)
    print(plot1)
    dev.off()
    
#Save the current identities as cluster metadata
ss_data_norm$clusternum <- Idents(ss_data_norm)

# Next, switch the identity class of all cells to reflect sample ID
Idents(ss_data_norm) <- "orig.ident"

#Make a standard UMAP plot of the clusters
plot2 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     #group.by = resolutions[[resolution]],
                     pt.size = 2,
                     label = TRUE,
                     label.size = 10)
    png(paste0(plotspath, "/", proj, "_",
                "integrated_samples", "_",
                label, suffix, ".png", sep = ""), 800, 800)
    print(plot2)
    dev.off()

```

## Save the data files.
```{r Save_Files}
rm(plot1, plot2)

#Save workspace image if needed to revisit
save.image(file = paste0("QCd_norm_anchored_ws", suffix, ".rdata"), compress = TRUE)

```

