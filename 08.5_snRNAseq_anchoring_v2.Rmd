---
title: "snRNAseq_clusters_v1"
author: "Katie Prater and Kevin Green"
date: "6/24/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(stringr)
library(dplyr)
library(filesstrings)
```
#Jayadev Lab snRNAseq Pipeline

##Removal of unwanted batch/sample effects for cleanup of data

### R Markdown note:
This is an R Markdown document. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

##First ensure you have the variables and directories set up as needed for the project. This should be identical to the code chunk you edited the first time. ***You DO need to edit this code chunk! ***
```{r Setup}
#Define your project folder:
#projdir <- "path_to_my_project_folder_name"
projdir <- "~/jayadev/PU.1/exp_2-25-20/Full_sequence/code/pu1_only/"

#Previous data file name: (give the name for the appopriate RDS/Rdata file)
start_data <- "QCd_normalized_pu1_only_ws.rdata"

#Define the assay name used during normalization ("RNA", "integrated" or "SCT")
assay <- "RNA"

#Define the number of genes you want after variable gene detection:
nfeatures <- 5000

#Set a list of reference samples to use for integration
#Set to NULL if no reference sample is used
reference_samples <- c(1, 8, 2, 3)


#__________________**DO NOT EDIT BELOW THIS LINE**___________________________
```

## Load in the data you specified:
```{r Load_Data}
#Document your code:
print("This is when this code was started:")
print(Sys.time())

#Load the thresholded Seurat object saved before
data_loc<-file.path(projdir, "code", start_data, fsep = "/")
print(paste('Loading data', start_data, sep = " "))
load(start_data)
```

```{r Set_Directories}
#Ensure paths are set for code:
outpath <- file.path(projdir, outdir, fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}

#Number of participants/samples to process:
numsubs <- length(samples)
print(paste("Processing", numsubs, "samples", sep = " "))

#Documentation:
print("This is where the project is:")
print(projdir)
print("This is where the sample files are:")
print(sample_dir)
print("This is where the data files will be saved:")
print(outpath)

```

## We split the Seurat object into individual samples to find the variable genes in each sample, generate a weighted list of those genes for all samples, and then determine integration anchors based on a reference defined above.
```{r Var_genes_&_anchors}
#Split the combined Seurat object into individual samples to be integrated
ss_data_norm_split <- SplitObject(
    ss_data_norm,
    split.by = "orig.ident")
print(paste("Split Seurat object now has", length(unique(Idents(ss_data_norm)))
, "individual samples.", sep = " "))

#Find the variable genes for each individual samples
ss_data_norm_split <- lapply(X = ss_data_norm_split, FUN = function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nfeatures, verbose = FALSE)
})

#Find the integration features similar across all samples for the top nFeatures of genes.
Ifeatures <- SelectIntegrationFeatures(ss_data_norm_split, nfeatures = nfeatures,)


# Find integration anchors for individual samples to correct for sample batch effects using the Integration features identified above. 
#*Note that this step takes many hours (7 for 15 samples)
print(paste("Finding integration anchors using", names(ss_data_norm_split[reference_samples]), "as reference samples.", sep = " "))
ss_data_norm_split <-
  FindIntegrationAnchors(ss_data_norm_split,
    reference = reference_samples,
    anchor.features = Ifeatures,
    reduction = "cca",
    dims = 1:30,
  )

#Save rds of the anchorset 
saveRDS(ss_data_norm_split, file = paste0("anchorset_data",suffix, ".rds"))

#Integrate the datasets from each sample together.
ss_data_norm <- IntegrateData(ss_data_norm_split,
                              dims = 1:30)


```
## Make a couple of quick umap plots to confirm that the batch correction worked well.
```{r UMAP_plots}

#Make a standard UMAP plot of the clusters
plot1 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     #group.by = resolutions[[resolution]],
                     pt.size = 2,
                     label = FALSE,
                     label.size = 10)
    png(paste0(plotspath, "/", proj, "_",
                "integrated_clusters", "_",
                "postQC", suffix, ".png", sep = ""), 800, 800)
    print(plot1)
    dev.off()
    
#Save the current identities as cluster metadata
ss_data_norm$clusternum <- Idents(ss_data_norm)

# Next, switch the identity class of all cells to reflect sample ID
Idents(ss_data_norm) <- "orig.ident"

#Make a standard UMAP plot of the clusters
plot2 <- DimPlot(object = ss_data_norm,
                     reduction = "umap",
                     #group.by = resolutions[[resolution]],
                     pt.size = 2,
                     label = TRUE,
                     label.size = 10)
    png(paste0(plotspath, "/", proj, "_",
                "integrated_samples", "_",
                label, suffix, ".png", sep = ""), 800, 800)
    print(plot2)
    dev.off()

```

## Save the data files.
```{r Save_Files}
rm(plot1, plot2)

#Save workspace image if needed to revisit
save.image(file = paste0("QCd_norm_anchored_ws", suffix, ".rdata"), compress = TRUE)

```

