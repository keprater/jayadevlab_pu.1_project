---
title: "snRNAseq_cluster_stats_optional_subset_clusters_v1"
author: "Katie Prater and Kevin Green"
date: "09/14/2020"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(Matrix)
library(ggplot2)
library(stringr)
library(dplyr)
library(filesstrings)
```
#Jayadev Lab snRNAseq Pipeline

##Output of numbers of nuclei for each cluster. Optional subsetting of dataset for further analysis after output of stats.

### R Markdown note:
This is an R Markdown document. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

##First ensure you have the variables and directories set up as needed for the project. This should be identical to the code chunk you edited the first time. ***You DO need to edit this code chunk! ***
```{r Setup}
#Previous data file name: (give the name for the appopriate RDS/Rdata file)
start_data <- "QCd_norm_anchored_clustered_wscale_ws_MG_subset_0.2subset012356_MG_subset_20200910.rdata" 

#Resolution chosen from previous clustering to use to label clusters:
change_resolution <- "0.3"

#Analyze clusters by specific grouping (i.e. a metadata variable)? - Boolean
clust_group <- TRUE

#If clust_group is TRUE, variables in your metadata to group the cluster numbers by (must match variable names in metadata). Otherwise, NULL.
meta_vars <- c("Dx",
               "Pt.ID")

#Subset dataset by cluster(s) for further analysis of just those nuclei? - Boolean
sample_sub <- FALSE

#If sample_sub = TRUE: Name for your subset dataset"
change_dataset_name <- NULL #"MG_subset_0.2subset012356"

#If sample_sub = TRUE: Give cluster name(s) to subset on (should match names in script 11 labeling). If False, give NULL.
subset_names <- c("0 Homeostatic/Motile",
                    "1 ARMS",
                    "2 Motile",
                    "3 ARMS/Motile 2",
                    "5 Mic1/Dystrophic",
                    "6 Mic1/Motile 1")
  #Original subset clusters:
  #"0 Microglia",
  #              "1 Microglia", 
  #              "4 Microglia",
  #              "7 MG/Oligs")

#__________________**DO NOT EDIT BELOW THIS LINE**___________________________
```

## Load in the data you specified:
```{r Load_Data}
#Document your code:
print(paste("This is when this code was started:", Sys.time()))

#Load the thresholded Seurat object saved before
print(paste('Loading data', start_data, sep = " "))
load(paste0("../data/r_files/", start_data))

if (!is.null(change_dataset_name)) {
  print(paste0("Changing dataset name to:", change_dataset_name))
  dataset_name <- change_dataset_name
}

#Ensure resolution to be used is set properly.
if (!is.null(change_resolution)) {
  chose_resolution <- change_resolution
}
```

```{r Set_Directories}
#Ensure paths are set for code:
outpath <- file.path(projdir, outdir, "umaps", fsep = "/")
if (file.exists(outpath))
    {cat("Output directory path works!")} else 
    {cat("Output directory does not exist - creating")
    dir.create(outpath)}

metrics_path <- "../output/output_pu1_only/data_metrics"
if (file.exists(metrics_path))
    {cat("Data metrics directory path works!")} else 
    {cat("Data metrics directory does not exist - creating")
    dir.create(metrics_path)}

#Number of participants/samples to process:
numsubs <- length(samples)
print(paste("Processing", numsubs, "samples", sep = " "))

#Documentation:
print("This is where the project is:")
print(projdir)
print("This is where the sample files are:")
print(sample_dir)
print("This is where the data files will be saved:")
print(outpath)
print("This is where the metrics files will be saved:")
print(metrics_path)

```

## Collect and output data tables for the number of cells in each cluster, collected by different metadata variables.

```{r Dataset_Cluster_Stats}
#Define the assay name to use ("RNA", "integrated" or "SCT")
assay <- "integrated"

#make resolution name:
res_name<- paste0(assay, "_snn_res.", chose_resolution)

#Set cluster identities in Seurat object
Idents(object = ss_data_norm)<-res_name

#Generate a table with the number of nuclei in each sample
sample_table <- table(ss_data_norm$Pt.ID)
print("The number of nuclei in each sample is:")
sample_table

#Generate a table with the # nuclei per cluster
overall <- table(Idents(ss_data_norm))
print("The number of nuclei in each cluster is:")
overall

#Generate a table with the proportion of nuclei in each cluster
prop_overall <- prop.table(table(Idents(ss_data_norm)))
print("The proportion of nuclei in each cluster is:")
prop_overall

# Generate a table with the number of nuclei in each cluster split by sample
clust_sample_table <- table(Idents(ss_data_norm), ss_data_norm$Pt.ID) #get(sub_var))
print(paste0("The number of nuclei in each cluster split by sample is:"))
clust_sample_table

# Generate a table with the number of nuclei in each cluster split by subset variable *****- need to make this flexible ****
#sub_var <- paste("ss_data_norm", var_subset, sep = "$")
subset_table <- table(Idents(ss_data_norm), ss_data_norm$Dx) #get(sub_var))
print(paste0("The number of nuclei in each cluster split by ", var_subset, " is:"))
subset_table

```
## Write these tables to a CSV file.
```{r Write_CSV}
#Write a CSV with all the tables output above to a file in the data metrics folder.

#Start the sink to write them all together to a single file
csv_name <- paste0(metrics_path,'/Post-Clustering_Dataset_Metrics', suffix,'.csv')

sink(csv_name)

 # Write the first table, with a title and final line separator 
cat('The number of nuclei in each sample is:')
write.csv(sample_table)
cat('____________________________')

cat('\n')
cat('\n')

# Write the 2nd table to the same sink
cat('The number of nuclei in each cluster is:')
write.csv(overall)
cat('____________________________')

cat('\n')
cat('\n')

# Write the 3rd table to the same sink
cat('The proportion of nuclei in each cluster is:')
write.csv(prop_overall)
cat('____________________________')

cat('\n')
cat('\n')

# Write the 4th table to the same sink
cat('The number of nuclei in each cluster split by sample is:')
write.csv(clust_sample_table)
cat('____________________________')

cat('\n')
cat('\n')

# Write the 5th table to the same sink
cat(paste0("The number of nuclei in each cluster split by ", var_subset, " is:"))
write.csv(subset_table)
cat('____________________________')

# Close the sink
sink()

```

## If the dataset is to be subset for further analysis, that happens here:
```{r Subset_Data}
#Check if subset needs to happen:
if (sample_sub) {
  #Subset the data with the clusters identified into a new Seurat object.
  print("Subsetting clusters:")
  subset_names
  assign(dataset_name, subset(ss_data_norm, idents = subset_names))
  print("The new dimensions of the subset dataset are:") 
  dim(get(dataset_name))
} else {
  print("The dataset will not be subset.")
}

```

## Save the subset data files.
```{r Save_Subset}
#Check if subset needs to happen:
if (sample_sub) {
  #Remove extra data
  rm(ss_data_norm, overall, prop_overall, subset_table, sample_table, csv_name, prev_data, prev_data_path, sample_sub, subset_names, clust_group, start_data, meta_vars, chose_resolution, change_dataset_name)

  #Save workspace image for the subset dataset:
  save.image(file = paste0("../data/r_files/", "QCd_norm_anchored_wscale_", dataset_name ,"_ws", suffix, ".rdata"), compress = TRUE)
} else {
  print(paste0("The data is saved in: ", start_data))
}

```

